# Infrastructure Pipeline Failure Bug Report

## Issue Summary
Infrastructure deployment pipeline failed when PR #111 was merged to main branch on 2025-06-21. The failure was caused by Pulumi configuration access issues in the Azure resource naming system.

## Affected Components
- **Infrastructure Deployment Pipeline** (`/.github/workflows/infrastructure.yml`)
- **Azure Resource Naming** (`/infrastructure/config/naming.py`)
- **Pulumi Configuration System**

## Timeline
- **2025-06-21 13:37:47Z**: PR #111 merged to main
- **Post-merge**: Infrastructure pipeline failed during deployment
- **2025-06-20 03:34:02Z**: Fix applied via commit `84315bc5`

## Root Cause Analysis

### Primary Issue
The `infrastructure/config/naming.py` module contained a configuration access bug that prevented proper reading of Pulumi project-specific configuration values.

**Specific Problem:**
```python
# FAILING CODE (before fix):
environment = config.get("environment") or pulumi.get_stack()

# The code wasn't properly accessing project-specific config:
# 'shift-scheduler-infra:environment'
```

**Fixed Code:**
```python
# WORKING CODE (after fix):
environment = (
    config.get("environment") 
    or pulumi.Config("shift-scheduler-infra").get("environment")
    or pulumi.get_stack()
)
```

### Secondary Issues
1. **Import Path Problems**: Configuration access wasn't properly structured
2. **Missing Validation**: No early validation to catch configuration issues
3. **Resource Naming Failures**: Incorrect configuration caused resource naming conflicts

## Impact Assessment

### Severity: **HIGH**
- **Infrastructure Deployment**: Complete failure of infrastructure provisioning
- **Resource Creation**: Azure resources couldn't be created due to naming conflicts
- **Development Workflow**: Blocked team from deploying infrastructure changes

### Affected Resources
- Resource Groups
- Storage Accounts
- Container Registries  
- Container Apps Environments
- Log Analytics Workspaces

## Resolution Applied

### Fix Commit: `84315bc5`
**Title**: "fix: resolve infrastructure pipeline configuration issues"

**Changes Made:**
1. **Fixed Configuration Access**: Updated `naming.py` to properly access project-specific Pulumi config
2. **Added Validation Script**: Created `validate_config.py` for early issue detection
3. **Improved Error Handling**: Better handling of configuration edge cases

### Validation Script Added
```python
# /infrastructure/validate_config.py
- Validates all imports and configuration access
- Tests naming convention generation
- Provides clear error messages for debugging
- Prevents deployment of broken configurations
```

## Files Modified
1. `/infrastructure/config/naming.py` - Core configuration fix
2. `/infrastructure/validate_config.py` - New validation script (added)

## Verification Steps
1. ✅ Pulumi configuration can be accessed properly
2. ✅ Resource naming functions work correctly
3. ✅ Infrastructure pipeline passes validation
4. ✅ Azure resources can be provisioned successfully

## Prevention Measures

### Implemented
- **Configuration Validation Script**: Catches config issues before deployment
- **Improved Error Handling**: Better debugging information
- **Multiple Fallback Strategies**: Config access with multiple fallback options

### Recommended
- **Pre-deployment Validation**: Run `validate_config.py` before all deployments
- **Enhanced Testing**: Add infrastructure configuration tests to CI/CD
- **Monitoring**: Add monitoring for infrastructure deployment failures

## Related Issues
- **Original Issue**: #67 - Azure Storage Account setup
- **Implementing PR**: #111 - feat: implement Azure Storage Account for job data
- **Fix Commit**: `84315bc5` - fix: resolve infrastructure pipeline configuration issues

## Lessons Learned
1. **Configuration Access**: Always validate Pulumi configuration access patterns
2. **Early Validation**: Implement validation scripts to catch issues before deployment
3. **Fallback Strategies**: Use multiple fallback options for configuration access
4. **Testing**: Infrastructure configuration needs comprehensive testing

## Status
**RESOLVED** - Fixed in commit `84315bc5` on 2025-06-20

---

*Bug report generated by Claude Code based on investigation of PR #111 infrastructure pipeline failure*